<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>我的购物车 - 悦读网上书店</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<nav class="navbar">
    <div class="nav-left">
        <a href="index.html" class="nav-item">首页</a>
        <a href="category.html" class="nav-item">全部分类</a>
    </div>

    <div class="nav-center">
        <div class="search-group">
            <input type="text" id="navSearchInput" placeholder="书名 / 作者 / ISBN">
            <button onclick="doNavSearch()">搜索</button>
        </div>
    </div>

    <div class="nav-right" id="userArea">
        <a href="login.html" class="nav-item">登录</a>
        <a href="register.html" class="nav-item">注册</a>
    </div>
</nav>

<main class="container">
    <h2>您的购物篮</h2>
    <div id="basketContent">
        <p>正在加载您的宝贝...</p>
    </div>

    <div id="basketSummary" class="basket-summary" style="display:none;">
        <hr>
        <h3>总计金额: <span id="totalPrice" class="price">￥0.00</span></h3>
        <button onclick="clearBasket()" class="secondary-btn">清空购物车</button>
        <button onclick="goToCheckout()" class="primary-btn">去结算</button>
    </div>
</main>

<script src="js/main.js"></script>
<script>
    // basket.html 结尾的脚本
    async function startBasketPage() {
        console.log("购物篮页面脚本开始执行...");

        // 1. 同步导航栏状态
        if (typeof syncUserStatus === 'function') {
            await syncUserStatus();
        } else if (typeof checkLoginStatus === 'function') {
            await checkLoginStatus();
        }

        // 2. 渲染列表
        renderBasket();
    }

    function renderBasket() {
        console.log("正在读取本地存储并渲染列表...");
        const container = document.getElementById('basketContent');
        const summary = document.getElementById('basketSummary');

        // 注意：这里的 Key 必须和 main.js 里的 addToCart 保持一致
        const basket = JSON.parse(localStorage.getItem('book_basket') || '[]');

        if (basket.length === 0) {
            container.innerHTML = `<p style="text-align:center; padding:50px;">您的购物篮是空的。</p>`;
            summary.style.display = 'none';
            return;
        }

        summary.style.display = 'block';
        let total = 0;
        let html = `
        <table class="basket-table" style="width:100%; border-collapse: collapse; margin-top:20px;">
            <tr style="border-bottom: 2px solid #ddd; text-align: left;">
                <th style="padding:10px;">图书</th>
                <th>单价</th>
                <th>数量</th>
                <th>小计</th>
                <th>操作</th>
            </tr>`;

        basket.forEach((item, index) => {
            const subtotal = item.price * item.quantity;
            total += subtotal;
            html += `
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding:15px 10px;">${item.title}</td>
                <td>￥${item.price.toFixed(2)}</td>
                <td>
                    <button onclick="changeQty(${index}, -1)" style="padding:2px 8px;">-</button>
                    <span style="margin:0 10px; min-width:20px; display:inline-block; text-align:center;">${item.quantity}</span>
                    <button onclick="changeQty(${index}, 1)" style="padding:2px 8px;">+</button>
                </td>
                <td style="color:#e4393c; font-weight:bold;">￥${subtotal.toFixed(2)}</td>
                <td><button onclick="deleteItem(${index})" style="color:red; background:none; border:none; cursor:pointer;">删除</button></td>
            </tr>`;
        });

        html += `</table>`;
        container.innerHTML = html;
        document.getElementById('totalPrice').innerText = `￥${total.toFixed(2)}`;
    }

    // 确保在 DOM 加载完后执行
    window.addEventListener('DOMContentLoaded', startBasketPage);

    // --- 操作函数 ---
    window.changeQty = function(index, delta) {
        let basket = JSON.parse(localStorage.getItem('book_basket'));
        basket[index].quantity += delta;
        if (basket[index].quantity <= 0) return deleteItem(index);
        localStorage.setItem('book_basket', JSON.stringify(basket));
        renderBasket();
    };

    window.deleteItem = function(index) {
        let basket = JSON.parse(localStorage.getItem('book_basket'));
        basket.splice(index, 1);
        localStorage.setItem('book_basket', JSON.stringify(basket));
        renderBasket();
    };

    window.clearBasket = function() {
        if (confirm("确定要清空购物篮吗？")) {
            localStorage.removeItem('book_basket');
            renderBasket();
        }
    };
</script>
</body>
</html>