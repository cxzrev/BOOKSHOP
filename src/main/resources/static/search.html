<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å›¾ä¹¦æœç´¢ - æ‚¦è¯»ç½‘ä¸Šä¹¦åº—</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<nav class="navbar">
    <div class="nav-left">
        <a href="index.html" class="nav-item">é¦–é¡µ</a>
        <a href="category.html" class="nav-item">å…¨éƒ¨åˆ†ç±»</a>
    </div>

    <div class="nav-center">
        <div class="search-group">
            <input type="text" id="navSearchInput" placeholder="ä¹¦å / ä½œè€… / ISBN">
            <button onclick="doNavSearch()">æœç´¢</button>
        </div>
    </div>

    <div class="nav-right" id="userArea">
        <a href="login.html" class="nav-item">ç™»å½•</a>
        <a href="register.html" class="nav-item">æ³¨å†Œ</a>
    </div>
</nav>

<main class="container">
    <div class="search-main" style="display: none;">
        <input type="text" id="searchInput">
        <button>æœç´¢</button>
    </div>

    <div id="searchResults" class="search-results-container">
        <p style="text-align:center; padding:50px; color:#999;">æ­£åœ¨å‡†å¤‡æœç´¢ç»“æœ...</p>
    </div>
</main>

<script src="js/main.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', async () => {
        // 1. åŒæ­¥ç™»å½•çŠ¶æ€ (è§£å†³é¦–é¡µå’Œæœç´¢é¡µçŠ¶æ€ä¸€è‡´æ€§)
        if (typeof checkLoginStatus === 'function') await checkLoginStatus();

        // 2. ä» URL æŠ“å–å‚æ•° q
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('q');

        if (query) {
            const decodedQuery = decodeURIComponent(query);

            // âœ… è§£å†³æœç´¢æ¡†å˜ç©ºï¼šå¡«å›å¯¼èˆªæ 
            const navInput = document.getElementById('navSearchInput');
            if (navInput) navInput.value = decodedQuery;

            // âœ… è§£å†³æ²¡ä¹¦ç±ï¼šä¸»åŠ¨å‘èµ· fetch
            performSearch(decodedQuery);
        } else {
            document.getElementById('searchResults').innerHTML = '<p style="text-align:center;padding:50px;color:#999;">è¾“å…¥å…³é”®è¯å¼€å¯æœç´¢ä¹‹æ—…å§</p>';
        }
    });

    async function performSearch(q) {
        const container = document.getElementById('searchResults');
        container.innerHTML = `<div style="text-align:center;padding:50px;">ğŸ” æ­£åœ¨ä¸ºæ‚¨æ£€ç´¢ "${q}"...</div>`;

        try {
            // è°ƒç”¨ä½  Controller é‡Œçš„ /api/search æ¥å£
            const res = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
            const result = await res.json();

            if (result.code === 200 && result.data && result.data.length > 0) {
                renderSearchResults(result.data);
            } else {
                container.innerHTML = `<div style="text-align:center;padding:50px;color:#999;">æŠ±æ­‰ï¼Œæ²¡æ‰¾åˆ°ä¸ "${q}" ç›¸å…³çš„ä¹¦ç±ã€‚</div>`;
            }
        } catch (error) {
            console.error("æœç´¢å¤±è´¥:", error);
            container.innerHTML = `<div style="text-align:center;padding:50px;color:red;">æœåŠ¡å¼‚å¸¸ï¼Œè¯·ç¨åå†è¯•ã€‚</div>`;
        }
    }

    function renderSearchResults(books) {
        const container = document.getElementById('searchResults');
        // é…è‰²æ–¹æ¡ˆä¸é¦–é¡µä¸€è‡´
        const colors = { 'marxism':'#d32f2f', 'philosophy':'#fbc02d', 'social':'#616161', 'politics':'#1976d2', 'economy':'#f57c00', 'military':'#388e3c', 'default':'#999' };

        container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; padding: 20px;">
            ${books.map(book => {
            // è‡ªåŠ¨æ˜ å°„åˆ†ç±» ID ä»¥è·å–é¢œè‰²
            const catId = window.getCatId ? window.getCatId(book.category) : 'default';
            const bid = book.bookId || book.book_id;

            return `
                <div class="book-card" style="background:#fff; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); overflow:hidden;">
                    <a href="book-info.html?id=${bid}" style="text-decoration:none; color:inherit;">
                        <div style="height:200px; background:${colors[catId] || '#999'}; display:flex; align-items:center; justify-content:center; color:#fff; font-size:50px; font-weight:bold;">
                            ${book.title[0]}
                        </div>
                        <div style="padding:12px;">
                            <div style="font-weight:bold; font-size:14px; margin-bottom:5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${book.title}</div>
                            <div style="font-size:12px; color:#666; margin-bottom:8px;">${book.author}</div>
                            <div style="color:#e4393c; font-weight:bold; font-size:16px;">ï¿¥${book.price.toFixed(2)}</div>
                        </div>
                    </a>
                </div>`;
        }).join('')}
        </div>`;
    }
</script>
</body>
</html>